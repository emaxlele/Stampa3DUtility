<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Preventivo Stampa 3D ‚Äî Bambu Lab H2C</title>
  <style>
    :root{
      --bg:#0f172a;
      --card:#111827;
      --muted:#9ca3af;
      --accent:#22c55e;
      --danger:#ef4444;
      --primary:#60a5fa;
      --border:#1f2937;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Noto Sans',sans-serif;}
    .wrap{max-width:920px;margin:2rem auto;padding:0 1rem;}
    h1{font-size:1.6rem;margin:0 0 1rem;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem 1.2rem;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    label{display:block;font-size:0.95rem;margin-top:0.6rem;}
    input,select{width:100%;padding:0.55rem 0.6rem;margin-top:0.28rem;border-radius:8px;border:1px solid var(--border);background:#0b1220;color:#fff}
    .row{display:flex;gap:0.6rem;align-items:center;justify-content:flex-start;margin-top:0.6rem;}
    .muted{color:var(--muted);font-size:0.9rem}
    .btn{padding:0.6rem 0.9rem;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:#fff;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:transparent;color:#001c32;font-weight:600}
    .btn.ghost{background:transparent}
    .btn.accent{background:var(--accent);color:#05210f;border-color:transparent;font-weight:700}
    .btn.danger{background:var(--danger);border-color:transparent;color:#2d0006;font-weight:700}
    .actions{display:flex;gap:0.8rem;flex-wrap:wrap;margin-top:1rem}
    .total{font-size:1.25rem;font-weight:800;margin-top:0.8rem}
    .break{background:#0b1220;border:1px solid var(--border);border-radius:10px;padding:0.8rem;margin-top:0.8rem;white-space:pre-wrap}
    .bad{color:var(--danger);font-weight:600}
    .ok{color:var(--accent);font-weight:600}
    .pill{display:inline-flex;align-items:center;gap:0.5rem;background:#0b1220;border:1px solid var(--border);border-radius:999px;padding:0.35rem 0.6rem;font-size:0.85rem;margin-top:0.5rem}
    .footer{margin-top:1rem;color:var(--muted);font-size:0.85rem}
    .hr{height:1px;background:var(--border);margin:1rem 0}
    /* Stampa */
    @media print{
      .btn,.actions,.footer{display:none !important}
      body{background:#fff;color:#000}
      .card{border-color:#ccc}
      .break{background:#fff;border-color:#ccc}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Preventivo Stampa 3D ‚Äî Bambu Lab H2C</h1>
    <div class="card">

      <!-- Selettori principali -->
      <div class="grid">
        <div>
          <label>Caso</label>
          <select id="case">
            <option value="A">üü¢ A ‚Äî Vendita (Mercatini/Clienti)</option>
            <option value="B">üîµ B ‚Äî Regali / Uso personale</option>
          </select>
        </div>
        <div>
          <label>Modalit√† macchina</label>
          <select id="mode">
            <option value="hobby">Hobby / occasionale (0,20 ‚Ç¨/h)</option>
            <option value="pro">Commerciale / continuativa (0,75 ‚Ç¨/h)</option>
          </select>
        </div>
      </div>

      <div class="grid">
        <div>
          <label>Grammi di materiale</label>
          <input id="grams" type="number" min="0" step="1" value="50">
        </div>
        <div>
          <label>Prezzo per grammo (‚Ç¨)</label>
          <input id="ppg" type="number" min="0" step="0.50" value="25.00" disabled>
          <div class="muted">Es.: 25‚Ç¨ per 1kg ‚Üí 25,00 ‚Ç¨/kg</div>
        </div>
      </div>

      <div class="grid">
        <div>
          <label>Ore di stampa</label>
          <input id="hours" type="number" min="0" step="0.1" value="3">
        </div>
        <div>
          <label>Tariffa macchina ‚Ç¨/h</label>
          <input id="rate" type="number" min="0" step="0.01" value="0.20" disabled>
          <div class="muted">Si aggiorna automaticamente con la modalit√† macchina</div>
        </div>
      </div>

      <div id="sellBox">
        <label>Prezzo di vendita previsto (‚Ç¨) <span class="muted">(solo Caso A)</span></label>
        <input id="sell" type="number" min="0" step="0.01" value="12.50">
      </div>

      <div class="grid">
        <div>
          <label>Fallimento</label>
          <select id="failure">
            <option value="none">Nessuno</option>
            <option value="file">Errore file del cliente</option>
            <option value="technical">Problema tecnico stampante</option>
          </select>
        </div>
        <div id="flashBox">
          <label>Stampa ‚Äúflash‚Äù (piccola) <span class="muted">(solo Caso B)</span></label>
          <select id="flash">
            <option value="false">No</option>
            <option value="true">S√¨</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="calcBtn">Calcola</button>
        <button class="btn ghost" id="resetBtn">Reset</button>
        <button class="btn" id="printBtn">Stampa / PDF</button>
      </div>

      <div class="pill">
        <span>Regole:</span>
        <span>Materiale a prezzo di listino</span> ¬∑
        <span>Macchina: 0,20 ‚Ç¨/h (hobby) / 0,75 ‚Ç¨/h (commerciale)</span> ¬∑
        <span>Fallimenti conteggiati</span>
      </div>

      <div id="notice" class="muted" style="margin-top:0.6rem"></div>

      <div class="hr"></div>

      <div class="total" id="total">Totale da darti: ‚Äî</div>
      <div class="break" id="breakdown">Inserisci i dati e premi ‚ÄúCalcola‚Äù.</div>

      <div class="footer">
        Suggerimenti: imposta <b>25,00 ‚Ç¨/kg</b> per bobine da 25‚Ç¨/kg, usa <b>0,20 ‚Ç¨/h</b> per hobby e
        <b>0,75 ‚Ç¨/h</b> per attivit√† continuativa. In caso di fallimento tecnico tuo, nel Caso A
        applichi il <b>25%</b> sul margine, altrimenti <b>30%</b>.
      </div>
    </div>
  </div>

  <script>
    // Elementi
    const els = {
      cas: document.getElementById('case'),
      mode: document.getElementById('mode'),
      grams: document.getElementById('grams'),
      ppg: document.getElementById('ppg'),
      hours: document.getElementById('hours'),
      rate: document.getElementById('rate'),
      sell: document.getElementById('sell'),
      failure: document.getElementById('failure'),
      flash: document.getElementById('flash'),
      total: document.getElementById('total'),
      breakdown: document.getElementById('breakdown'),
      calcBtn: document.getElementById('calcBtn'),
      resetBtn: document.getElementById('resetBtn'),
      printBtn: document.getElementById('printBtn'),
      sellBox: document.getElementById('sellBox'),
      flashBox: document.getElementById('flashBox'),
      notice: document.getElementById('notice'),
    };

    // Utilit√†
    const f2 = (x) => (Math.round(x * 100) / 100).toFixed(2);
    const ‚Ç¨ = (x) => `‚Ç¨ ${f2(x)}`;

    function saveState(){
      const data = {
        cas: els.cas.value,
        mode: els.mode.value,
        grams: els.grams.value,
        ppg: els.ppg.value,
        hours: els.hours.value,
        rate: els.rate.value,
        sell: els.sell.value,
        failure: els.failure.value,
        flash: els.flash.value
      };
      localStorage.setItem('h2c_calc', JSON.stringify(data));
    }

    function loadState(){
      const raw = localStorage.getItem('h2c_calc');
      if(!raw) return;
      try{
        const data = JSON.parse(raw);
        Object.entries(data).forEach(([k,v])=>{
          if(els[k]) els[k].value = v;
        });
      }catch(e){}
      applyModeRate();
      toggleCaseFields();
      calc(); // mostra ultimo risultato
    }

    function applyModeRate(){
      els.rate.value = (els.mode.value === 'pro') ? '0.75' : '0.20';
    }

    function toggleCaseFields(){
      const isA = (els.cas.value === 'A');
      els.sellBox.style.display = isA ? 'block' : 'none';
      els.flashBox.style.display = isA ? 'none' : 'block';
    }

    function validate(){
      const problems = [];
      const g = parseFloat(els.grams.value||'0');
      const ppg = parseFloat(els.ppg.value||'0');
      const h = parseFloat(els.hours.value||'0');
      const rate = parseFloat(els.rate.value||'0');

      if(isNaN(g) || g < 0) problems.push("Grammi non validi.");
      if(isNaN(ppg) || ppg < 0) problems.push("Prezzo/grammo non valido.");
      if(isNaN(h) || h < 0) problems.push("Ore non valide.");
      if(isNaN(rate) || rate < 0) problems.push("Tariffa macchina non valida.");

      if(els.cas.value==='A'){
        const sell = parseFloat(els.sell.value||'0');
        if(isNaN(sell) || sell < 0) problems.push("Prezzo di vendita non valido.");
      }
      return problems;
    }

    function calc(){
      const issues = validate();
      if(issues.length){
        els.total.textContent = "Totale da darti: ‚Äî";
        els.breakdown.innerHTML = `<span class="bad">Correggi:</span>\n‚Ä¢ ${issues.join("\n‚Ä¢ ")}`;
        return;
      }

      const cas = els.cas.value;
      const grams = parseFloat(els.grams.value);
      const ppg = parseFloat(els.ppg.value) / 1000;
      const hours = parseFloat(els.hours.value);
      const rate = parseFloat(els.rate.value);
      const sell = parseFloat(els.sell.value || '0');
      const failure = els.failure.value;
      const flash = (els.flash.value === 'true');

      // Costi base
      const materialCost = grams * ppg;
      const machineCost = hours * rate;

      let breakdown = {};
      let totalToYou = 0;

      if(cas === 'A'){
        // Caso A ‚Äî Vendita
        const baseCost = materialCost + machineCost;
        const profit = sell - baseCost;

        const marginPct = (failure === 'technical') ? 0.25 : 0.30;
        const yourShare = Math.max(0, profit * marginPct);

        totalToYou = baseCost + yourShare;

        breakdown = {
          "Materiale": ‚Ç¨(materialCost),
          "Costo macchina": ‚Ç¨(machineCost),
          "Costo base (M+Macchina)": ‚Ç¨(baseCost),
          "Prezzo di vendita": ‚Ç¨(sell),
          "Utile (Vendita - Base)": ‚Ç¨(profit),
          "Tua % su utile": (marginPct*100).toFixed(0) + "%",
          "Tuo 30/25% su utile": ‚Ç¨(yourShare),
          "Totale da darti": ‚Ç¨(totalToYou)
        };

        // Nota sui fallimenti
        if(failure === 'file'){
          els.notice.innerHTML = "Fallimento per file difettoso del cliente: <b>materiale e tempo</b> sono conteggiati a costo pieno.";
        }else if(failure === 'technical'){
          els.notice.innerHTML = "Fallimento tecnico tuo: applichi <b>25%</b> sul margine invece di 30%.";
        }else{
          els.notice.textContent = "";
        }

      } else {
        // Caso B ‚Äî Regali / Uso personale
        const liveCosts = materialCost + machineCost;

        let fixedFee = 0;
        if(flash){
          fixedFee = 1.00;
        } else if(hours <= 5){
          fixedFee = 2.00;
        } else {
          const extraBlocks = Math.ceil((hours - 5) / 5); // blocchi da 5h
          fixedFee = 2.00 + extraBlocks * 1.00;
        }

        totalToYou = liveCosts + fixedFee;

        breakdown = {
          "Materiale": ‚Ç¨(materialCost),
          "Costo macchina": ‚Ç¨(machineCost),
          "Costi vivi": ‚Ç¨(liveCosts),
          "Tuo fisso": ‚Ç¨(fixedFee),
          "Totale da darti": ‚Ç¨(totalToYou)
        };

        // Nota sui fallimenti (policy uguale: costi vivi sempre conteggiati)
        if(failure === 'file'){
          els.notice.innerHTML = "Fallimento per file difettoso del cliente: <b>materiale e tempo</b> sono conteggiati a costo pieno.";
        }else if(failure === 'technical'){
          els.notice.innerHTML = "Fallimento tecnico tuo: mantieni <b>costi vivi</b> e il <b>fisso</b> come da policy.";
        }else{
          els.notice.textContent = "";
        }
      }

      // Output
      els.total.textContent = `Totale da darti: ${‚Ç¨(totalToYou)}`;
      els.breakdown.textContent = Object.entries(breakdown)
        .map(([k,v]) => `${k}: ${v}`)
        .join("\n");

      saveState();
    }

    function resetAll(){
      els.cas.value = 'A';
      els.mode.value = 'hobby';
      els.grams.value = 50;
      els.ppg.value = 25.00;
      els.hours.value = 3;
      els.rate.value = 0.20;
      els.sell.value = 12.50;
      els.failure.value = 'none';
      els.flash.value = 'false';
      toggleCaseFields();
      applyModeRate();
      els.notice.textContent = "";
      els.total.textContent = "Totale da darti: ‚Äî";
      els.breakdown.textContent = "Inserisci i dati e premi ‚ÄúCalcola‚Äù.";
      localStorage.removeItem('h2c_calc');
    }

    // Eventi
    els.mode.addEventListener('change', applyModeRate);
    els.cas.addEventListener('change', () => { toggleCaseFields(); calc(); });
    ['grams','ppg','hours','rate','sell','failure','flash'].forEach(id=>{
      els[id].addEventListener('input', () => { /* calcolo live opzionale */ });
      els[id].addEventListener('change', calc);
    });
    els.calcBtn.addEventListener('click', calc);
    els.resetBtn.addEventListener('click', resetAll);
    els.printBtn.addEventListener('click', () => window.print());

    // Init
    applyModeRate();
    toggleCaseFields();
    loadState();
  </script>
</body>
</html>
